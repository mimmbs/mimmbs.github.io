import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const url = "https://blkpgtebgzydbutkccvh.supabase.co";
const key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsa3BndGViZ3p5ZGJ1dGtjY3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTQ5NTA5NzUsImV4cCI6MjAxMDUyNjk3NX0.qEgLwoUvWWtZTRDUcVvD7En4Kkgc3yzQgeuqlwUKNy0";
        
const supabase = createClient(url, key);

Deno.serve(async (Request) => {
    let data = {};
    const path = new URL(Request.url).pathname;
    if (path == "/info") {
        let usd, eur;
        try {
            const dovizcom = await fetch('https://www.doviz.com');
            const doviz = await dovizcom.text();
            const eurString = `Euro\",\"latest_value_str\":\"`;
            const eurIndex = doviz.indexOf(eurString);
            const usdString = `Dolar\\u0131\",\"latest_value_str\":\"`;
            const usdIndex = doviz.indexOf(usdString);
            usd = doviz.substring(usdIndex, doviz.length).replace(usdString, "").substring(0, 5);
            eur = doviz.substring(eurIndex, doviz.length).replace(eurString, "").substring(0, 5);
        } catch(err) {
            usd = '?';
            eur = '?';
            console.log(err);
        }
        const d = new Date();
        d.setHours(d.getHours() + 3);
        const info = { calendar: { date: d.toLocaleDateString("tr-TR"), time: d.toLocaleTimeString("tr-TR").slice(0, 5) }, currency: { eur: eur, usd: usd } };
        data = info;
    }

    if (path == "/tr-TR") {
        const pack = await supabase.from('languages').select('package').eq('culture', 'tr-TR');
        data = pack.data[0].package;
    }

    if (path == "/customers") {
        const list = await supabase.from('customers').select('list');
        data = list.data[0].list;
    }

    if (path == "/login") {
        const stream = await Request.body?.getReader().read();
        const text = new TextDecoder("utf-8").decode(stream?.value); 
        const json = JSON.parse(text);
        if (json.username == "unsal" && json.password == "758") {
            data = { login: true };
        } else {
            data = { login: false };
        }
    }

    if (path == "/transactions") {
        const stream = await Request.body?.getReader().read();
        const text = new TextDecoder("utf-8").decode(stream?.value); 
        try {
        const list = await supabase
                .from('transactions')
                .select('saved_data')
                .eq('customer_id', JSON.parse(text))
        data = list.data[0].saved_data;
        } catch {
            data = [];
        }
    }

    if (path == "/savetransactions") {
        const stream = await Request.body?.getReader().read();
        const text = new TextDecoder("utf-8").decode(stream?.value); 
        const json = JSON.parse(text);
        const state = await supabase
                .from('transactions')
                .select()
                .eq('customer_id', json.customer);
        if (state.data.length > 0) {
            await supabase
                .from('transactions')
                .update({ saved_data: json.transactions })
                .eq('customer_id', json.customer)
                .select();
        } else {
            await supabase
                .from('transactions')
                .insert([{ customer_id: json.customer, saved_data: json.transactions }])
                .select();
        }
    }

    if (path == "/savecustomers") {
        const stream = await Request.body?.getReader().read();
        const text = new TextDecoder("utf-8").decode(stream?.value); 
        await supabase
                .from('customers')
                .update({ list: JSON.parse(text) })
                .eq('id', 1)
                .select();
    }

    if (path == "/savelog") {
        const stream = await Request.body?.getReader().read();
        const text = new TextDecoder("utf-8").decode(stream?.value); 
        await supabase
            .from('logs')
            .insert([{ log_data: JSON.parse(text) }])
            .select();
    }

    return new Response(JSON.stringify(data), {
        headers: {
            "Access-Control-Allow-Origin": "https://mimmbs.github.io",
        },
    });
});
